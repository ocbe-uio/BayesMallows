
beach_small <- subset(
  beach_preferences,
  bottom_item %in% 1:3 & top_item %in% 1:3
)

b <- compute_mallows(
  data = setup_rank_data(preferences = beach_preferences),
  compute_options = set_compute_options(nmc = 10),
  seed = 123L
)
b$burnin <- 2
cp <- compute_consensus(b)
map <- compute_consensus(b, type = "MAP")

test_that("compute_consensus returns correct object", {
  expect_true(inherits(cp, "data.frame"))
  expect_true(inherits(map, "data.frame"))
})

test_that("compute_consensus computes correctly for rho", {
  expect_equal(cp, structure(list(ranking = c(
    1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11,
    12, 13, 14, 15
  ), item = c(
    "Item 3", "Item 11", "Item 4", "Item 12",
    "Item 1", "Item 14", "Item 7", "Item 13", "Item 8", "Item 6",
    "Item 15", "Item 10", "Item 5", "Item 9", "Item 2"
  ), cumprob = c(
    0.875,
    1, 0.625, 1, 1, 1, 1, 1, 1, 0.75, 1, 0.625, 1, 1, 1
  )), row.names = c(
    NA,
    -15L
  ), class = "data.frame"))

  expect_equal(
    map,
    structure(list(
      map_ranking = c(
        1, 1, 1, 2, 2, 2, 3, 3, 3, 4,
        4, 4, 5, 5, 5, 6, 6, 6, 7, 7, 7, 8, 8, 8, 9, 9, 9, 10, 10, 10,
        11, 11, 11, 12, 12, 12, 13, 13, 13, 14, 14, 14, 15, 15, 15
      ),
      item = c(
        "Item 3", "Item 3", "Item 3", "Item 11", "Item 11",
        "Item 11", "Item 4", "Item 4", "Item 12", "Item 4", "Item 12",
        "Item 12", "Item 1", "Item 1", "Item 1", "Item 14", "Item 14",
        "Item 14", "Item 7", "Item 7", "Item 7", "Item 13", "Item 13",
        "Item 13", "Item 8", "Item 8", "Item 8", "Item 6", "Item 6",
        "Item 15", "Item 6", "Item 15", "Item 15", "Item 5", "Item 10",
        "Item 10", "Item 5", "Item 5", "Item 10", "Item 9", "Item 9",
        "Item 9", "Item 2", "Item 2", "Item 2"
      ), probability = c(
        0.25,
        0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25,
        0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25,
        0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25,
        0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25, 0.25,
        0.25, 0.25, 0.25, 0.25
      )
    ), row.names = c(NA, -45L), class = "data.frame")
  )
})

dat <- setup_rank_data(preferences = beach_small)
b2 <- compute_mallows(
  data = dat,
  compute_options = set_compute_options(nmc = 500, save_aug = TRUE),
  seed = 123L)
b3 <- compute_mallows(
  data = dat,
  compute_options = set_compute_options(nmc = 500, save_aug = TRUE, aug_thinning = 3),
  seed = 123L)

test_that("compute_consensus fails when it should", {
  # Burnin not set
  expect_error(compute_consensus(b2, type = "CP"))
  expect_error(compute_consensus(b2, type = "MAP"))

  # Augmented data are missing
  expect_error(compute_consensus(b, burnin = 200, type = "CP", parameter = "Rtilde"))
  expect_error(compute_consensus(b, burnin = 200, type = "MAP", parameter = "Rtilde"))

  # Incorrect assessor
  expect_error(compute_consensus(b2, burnin = 200, type = "CP", parameter = "Rtilde", assessors = 0))
  expect_error(compute_consensus(b2, burnin = 200, type = "MAP", parameter = "Rtilde", assessors = 0))
})

test_that("compute_consensus computes augmented ranks correctly", {
  res <- compute_consensus(b2, type = "CP", burnin = 200, parameter = "Rtilde", assessors = 1L)
  expect_equal(res, structure(list(assessor = c("1", "1", "1"), ranking = c(
    1, 2,
    3
  ), item = c("Item 1", "Item 3", "Item 2"), cumprob = c(
    0.62,
    1, 1
  )), row.names = c(NA, -3L), class = "data.frame"))

  res <- compute_consensus(b3, type = "CP", burnin = 200, parameter = "Rtilde", assessors = 1L)
  expect_equal(res, structure(list(assessor = c("1", "1", "1"), ranking = c(
    1, 2,
    3
  ), item = c("Item 1", "Item 3", "Item 2"), cumprob = c(
    0.61,
    1, 1
  )), row.names = c(NA, -3L), class = "data.frame"))


  res <- compute_consensus(b2, type = "CP", burnin = 200, parameter = "Rtilde", assessors = c(3L, 5L))
  expect_equal(
    res,
    structure(
      list(
        assessor  = c("3", "3", "3", "5", "5", "5"),
        ranking   = c(1, 2, 3, 1, 2, 3),
        item      = c("Item 1", "Item 3", "Item 2", "Item 1", "Item 3", "Item 2"),
        cumprob   = c(0.696666666666667, 0.836666666666667, 1, 1, 1, 1)
      ),
      row.names = c(NA, -6L),
      class = "data.frame"
    )
  )

  res <- compute_consensus(b3, type = "CP", burnin = 200, parameter = "Rtilde", assessors = c(3L, 5L))
  expect_equal(
    res,
    structure(
      list(
        assessor = c("3", "3", "3", "5", "5", "5"),
        ranking = c(1, 2, 3, 1, 2, 3),
        item = c("Item 1", "Item 3", "Item 2", "Item 1", "Item 3", "Item 2"),
        cumprob = c(0.69, 0.84, 1, 1, 1, 1)
      ),
      row.names = c(NA, -6L),
      class = "data.frame"
    )
  )

  res <- compute_consensus(b2, type = "MAP", burnin = 200, parameter = "Rtilde", assessors = 1L)
  expect_equal(res, structure(list(assessor = c(1, 1, 1), map_ranking = c(1, 2, 3), item = c("Item 1", "Item 3", "Item 2"), probability = c(
    0.62,
    0.62, 0.62
  )), row.names = c(NA, -3L), class = "data.frame"))

  res <- compute_consensus(b3, type = "MAP", burnin = 200, parameter = "Rtilde", assessors = 1L)
  expect_equal(
    res,
    structure(list(assessor = c(1, 1, 1), map_ranking = c(1, 2, 3), item = c("Item 1", "Item 3", "Item 2"), probability = c(
      0.61,
      0.61, 0.61
    )), row.names = c(NA, -3L), class = "data.frame")
  )

  res <- compute_consensus(b2, type = "MAP", burnin = 200, parameter = "Rtilde", assessors = c(5L, 3L))
  expect_equal(res, structure(list(assessor = c(3, 3, 3, 5, 5, 5), map_ranking = c(
    1,
    2, 3, 1, 2, 3
  ), item = c(
    "Item 1", "Item 3", "Item 2", "Item 1",
    "Item 3", "Item 2"
  ), probability = c(
    0.533333333333333, 0.533333333333333,
    0.533333333333333, 1, 1, 1
  )), row.names = c(NA, -6L), class = "data.frame"))

  res <- compute_consensus(b3, type = "MAP", burnin = 200, parameter = "Rtilde", assessors = c(5L, 3L))

  expect_equal(
    res,
    structure(list(assessor = c(3, 3, 3, 5, 5, 5), map_ranking = c(
      1,
      2, 3, 1, 2, 3
    ), item = c(
      "Item 1", "Item 3", "Item 2", "Item 1",
      "Item 3", "Item 2"
    ), probability = c(
      0.53, 0.53, 0.53, 1, 1,
      1
    )), row.names = c(NA, -6L), class = "data.frame")
  )
})
