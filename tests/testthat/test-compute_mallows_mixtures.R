library(parallel)
test_that("compute_mallows_mixtures works", {
  set.seed(1234)
  n_clusters <- c(1, 4, 6)
  models <- compute_mallows_mixtures(
    n_clusters = n_clusters,
    nmc = 20L,
    rankings = sushi_rankings[1:100, ]
  )

  expect_equal(
    round(models[[1]]$alpha$value, 10),
    c(
      1, 0.9613263178, 0.9613263178, 0.8831344651, 0.9125035114,
      0.9125035114, 0.8865988675, 0.8865988675, 0.8865988675, 0.8865988675,
      0.8205473633, 0.8205473633, 0.6941503586, 0.767450906, 0.7817768491,
      0.882383532, 0.9845249867, 0.9283154749, 1.1219871023, 1.0797258265
    )
  )

  expect_equal(
    models[[2]]$rho$value,
    c(7, 10, 2, 4, 3, 6, 9, 5, 1, 8, 7, 10, 2, 4, 3, 6, 9, 5, 1,
      8, 7, 10, 2, 4, 3, 6, 9, 5, 1, 8, 7, 10, 2, 4, 3, 6, 9, 5, 1,
      8, 7, 10, 2, 4, 3, 6, 9, 5, 1, 8, 7, 10, 2, 3, 5, 6, 9, 4, 1,
      8, 7, 10, 2, 4, 3, 6, 9, 5, 1, 8, 7, 10, 2, 4, 3, 6, 9, 5, 1,
      8, 7, 10, 2, 4, 3, 6, 9, 5, 1, 8, 7, 10, 2, 3, 5, 6, 8, 4, 1,
      9, 7, 10, 2, 5, 4, 6, 9, 3, 1, 8, 6, 10, 2, 4, 3, 7, 9, 5, 1,
      8, 7, 10, 1, 4, 3, 6, 9, 5, 2, 8, 7, 10, 2, 3, 5, 6, 8, 4, 1,
      9, 7, 10, 2, 5, 4, 6, 9, 3, 1, 8, 6, 10, 2, 3, 4, 7, 9, 5, 1,
      8, 7, 10, 1, 4, 3, 6, 9, 5, 2, 8, 5, 10, 2, 3, 6, 7, 8, 4, 1,
      9, 6, 10, 2, 5, 4, 7, 9, 3, 1, 8, 6, 10, 3, 2, 4, 7, 9, 5, 1,
      8, 7, 10, 1, 4, 3, 6, 9, 5, 2, 8, 5, 8, 2, 3, 6, 7, 9, 4, 1,
      10, 6, 10, 2, 5, 4, 7, 9, 3, 1, 8, 6, 10, 2, 3, 4, 7, 9, 5, 1,
      8, 7, 10, 1, 4, 3, 6, 9, 5, 2, 8, 5, 8, 2, 3, 6, 7, 9, 4, 1,
      10, 5, 10, 2, 6, 4, 7, 9, 3, 1, 8, 5, 10, 2, 3, 6, 7, 9, 4, 1,
      8, 7, 10, 1, 4, 3, 6, 9, 5, 2, 8, 5, 8, 2, 3, 6, 7, 9, 4, 1,
      10, 5, 9, 2, 6, 4, 7, 10, 3, 1, 8, 6, 10, 2, 3, 5, 7, 9, 4, 1,
      8, 7, 8, 1, 4, 3, 6, 10, 5, 2, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 5, 9, 4, 6, 3, 7, 10, 2, 1, 8, 6, 10, 2, 3, 5, 8, 7, 4, 1,
      9, 7, 8, 1, 5, 3, 6, 10, 4, 2, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 5, 10, 4, 6, 3, 7, 9, 2, 1, 8, 6, 8, 2, 3, 5, 9, 7, 4, 1,
      10, 6, 8, 1, 5, 3, 7, 10, 4, 2, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 4, 10, 5, 6, 3, 7, 9, 2, 1, 8, 5, 8, 2, 3, 6, 9, 7, 4, 1,
      10, 6, 8, 2, 5, 3, 7, 10, 4, 1, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 4, 10, 5, 6, 3, 7, 9, 2, 1, 8, 5, 8, 2, 3, 6, 10, 7, 4, 1,
      9, 6, 8, 4, 5, 2, 7, 10, 3, 1, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 4, 10, 5, 7, 3, 6, 9, 2, 1, 8, 5, 8, 1, 3, 6, 10, 7, 4, 2,
      9, 6, 8, 4, 5, 1, 7, 10, 2, 3, 9, 5, 8, 1, 2, 6, 7, 9, 4, 3,
      10, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 8, 1, 3, 6, 9, 7, 4, 2,
      10, 6, 8, 4, 5, 1, 7, 9, 2, 3, 10, 5, 7, 1, 2, 6, 8, 9, 4, 3,
      10, 4, 9, 5, 7, 2, 6, 10, 1, 3, 8, 5, 7, 1, 3, 6, 9, 8, 4, 2,
      10, 6, 8, 4, 5, 1, 7, 9, 2, 3, 10, 5, 7, 1, 2, 6, 8, 9, 4, 3,
      10, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 9, 1, 3, 6, 8, 7, 4, 2,
      10, 6, 8, 4, 5, 2, 7, 9, 1, 3, 10, 5, 8, 1, 2, 6, 9, 7, 4, 3,
      10, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 10, 1, 3, 6, 8, 7, 4, 2,
      9, 6, 8, 4, 5, 1, 7, 9, 2, 3, 10, 5, 9, 1, 2, 6, 7, 8, 4, 3,
      10, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 10, 1, 3, 6, 7, 8, 4, 2,
      9, 6, 8, 4, 5, 1, 7, 9, 2, 3, 10, 5, 8, 1, 2, 6, 7, 10, 4, 3,
      9, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 10, 2, 3, 6, 7, 8, 4, 1,
      9, 6, 8, 4, 5, 1, 7, 9, 2, 3, 10, 5, 7, 1, 2, 8, 6, 10, 4, 3,
      9, 4, 10, 5, 7, 2, 6, 9, 1, 3, 8, 5, 8, 2, 3, 6, 7, 9, 4, 1,
      10)
  )

  expect_equal(
    models[[3]]$rho_acceptance,
    structure(c(0.65, 1, 0.9, 0.9, 0.65, 0.8), dim = c(6L, 1L))
  )


  set.seed(123)
  mixture_model <- compute_mallows(
    rankings = sushi_rankings[1:100, ], n_clusters = 5,
    include_wcd = TRUE, save_clus = TRUE, nmc = 10
  )

  expect_equal(
    mixture_model$within_cluster_distance$value,
    c(632, 670, 700, 726, 568, 518, 490, 936, 924, 428, 360, 426,
      1252, 838, 402, 230, 642, 1086, 756, 484, 288, 684, 870, 838,
      516, 460, 992, 968, 442, 330, 514, 724, 978, 320, 578, 484, 584,
      1048, 444, 484, 520, 650, 1064, 374, 354, 508, 380, 1442, 404,
      218)
  )

  # check that it runs in parallel
  cl <- makeCluster(1)
  models <- compute_mallows_mixtures(
    n_clusters = n_clusters,
    nmc = 20L,
    rankings = sushi_rankings[1:100, ],
    cl = cl
  )
  stopCluster(cl)
  expect_s3_class(models, "BayesMallowsMixtures")
})
