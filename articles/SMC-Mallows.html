<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="BayesMallows">
<title>Sequential Monte Carlo for the Bayesian Mallows model • BayesMallows</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="Sequential Monte Carlo for the Bayesian Mallows model">
<meta property="og:description" content="BayesMallows">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">BayesMallows</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">2.1.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="nav-item">
  <a class="nav-link" href="../articles/BayesMallows.html">Get started</a>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/SMC-Mallows.html">Sequential Monte Carlo for the Bayesian Mallows model</a>
    <a class="dropdown-item" href="../articles/parallel_chains.html">MCMC with Parallel Chains</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../news/index.html">Changelog</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/ocbe-uio/BayesMallows/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">


<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>Sequential Monte Carlo for the Bayesian Mallows model</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/ocbe-uio/BayesMallows/blob/HEAD/vignettes/SMC-Mallows.Rmd" class="external-link"><code>vignettes/SMC-Mallows.Rmd</code></a></small>
      <div class="d-none name"><code>SMC-Mallows.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/ocbe-uio/BayesMallows" class="external-link">BayesMallows</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://ggplot2.tidyverse.org" class="external-link">ggplot2</a></span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span></code></pre></div>
<p>This vignette describes sequential Monte Carlo (SMC) algorithms to
provide updated approximations to the posterior distribution of a single
Mallows model. We consider scenarios where we receive sequential
information in the form of complete rankings, partial rankings and
updated rankings from existing individuals who have previously provided
a (partial) ranking. This vignette focuses on the code. For an in-depth
treatment of the implemented methodology, see <span class="citation">Stein (<a href="#ref-steinSequentialInferenceMallows2023">2023</a>)</span> which
is available
<a href="https://eprints.lancs.ac.uk/id/eprint/195759/" target="_blank" class="external-link">here</a>.</p>
<div class="section level2">
<h2 id="new-users-with-complete-rankings">New users with complete rankings<a class="anchor" aria-label="anchor" href="#new-users-with-complete-rankings"></a>
</h2>
<p>We use the <code>sushi_rankings</code> dataset to illustrate the
methodology <span class="citation">(<a href="#ref-kamishima2003nantonac">Kamishima 2003</a>)</span>. This
dataset contains 5000 complete rankings for 10 sushi dishes.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">sushi_rankings</span><span class="op">)</span></span>
<span><span class="co">#&gt;      shrimp sea eel tuna squid sea urchin salmon roe egg fatty tuna tuna roll cucumber roll</span></span>
<span><span class="co">#&gt; [1,]      2       8   10     3          4          1   5          9         7             6</span></span>
<span><span class="co">#&gt; [2,]      1       8    6     4         10          9   3          5         7             2</span></span>
<span><span class="co">#&gt; [3,]      2       8    3     4          6          7  10          1         5             9</span></span>
<span><span class="co">#&gt; [4,]      4       7    5     6          1          2   8          3         9            10</span></span>
<span><span class="co">#&gt; [5,]      4      10    7     5          9          3   2          8         1             6</span></span>
<span><span class="co">#&gt; [6,]      4       6    2    10          7          5   1          9         8             3</span></span></code></pre></div>
<p>The SMC methodology is designed for the case where date arrive in
batches. Assume that we initially have only 300 observed rankings, in
<code>data_batch1</code>:</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch1</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">300</span>, <span class="op">]</span></span></code></pre></div>
<p>We estimate a model on these data using
<code><a href="../reference/compute_mallows.html">compute_mallows()</a></code>, which runs a full Metropolis-Hastings
algorithm.</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_mallows.html">compute_mallows</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We assess convergence, and find that 300 is an appropriate burnin
value.</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/assess_convergence.html">assess_convergence</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="convergence_smc_full-1.png" alt="Trace plot for SMC model." height="4cm"><p class="caption">
Trace plot for SMC model.
</p>
</div>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/burnin.html">burnin</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">300</span></span></code></pre></div>
<p>Having saved this model, assume we receive another batch of
preferences at a later timepoint, with an additional 300 rankings.</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch2</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">301</span><span class="op">:</span><span class="fl">600</span>, <span class="op">]</span></span></code></pre></div>
<p>We can now update the initial model, without rerunning the full
Metropolis-Hastings algorithm, by calling <code><a href="../reference/update_mallows.html">update_mallows()</a></code>.
This function uses the sequential Monte Carlo algorithm of <span class="citation">Stein (<a href="#ref-steinSequentialInferenceMallows2023">2023</a>)</span>, and
extracts a thinned sample of size <code>n_particles</code> from
<code>model1</code> as initial values.</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model1</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch2</span><span class="op">)</span>, </span>
<span>  smc_options <span class="op">=</span> <span class="fu"><a href="../reference/set_smc_options.html">set_smc_options</a></span><span class="op">(</span>n_particles <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>All the posterior summary methods can be used for
<code>model2</code>. For example, we can plot the posterior of <span class="math inline">\(\alpha\)</span>.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_model2_alpha-1.png" alt="Posterior distribution of scale parameter for model 2." height="4cm"><p class="caption">
Posterior distribution of scale parameter for model 2.
</p>
</div>
<p>And we can plot the posterior of the latent ranks of selected
items:</p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model2</span>, parameter <span class="op">=</span> <span class="st">"rho"</span>, items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shrimp"</span>, <span class="st">"sea eel"</span>, <span class="st">"tuna"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_model2-1.png" alt="Posterior distribution of selected latent rankings for model 2." height="2cm"><p class="caption">
Posterior distribution of selected latent rankings for model 2.
</p>
</div>
<p>Next, assume we get yet another set of rankings later, now of size
1000.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch3</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">601</span><span class="op">:</span><span class="fl">1600</span>, <span class="op">]</span></span></code></pre></div>
<p>We can re-update the model.</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span><span class="va">model2</span>, new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>We can again plot posterior quantities, and the plots reveal that as
expected, the posterior uncertainty about the rankings has decreased
once we added more data.</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model3</span>, parameter <span class="op">=</span> <span class="st">"rho"</span>, items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shrimp"</span>, <span class="st">"sea eel"</span>, <span class="st">"tuna"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_model3-1.png" alt="Posterior distribution of selected latent rankings for model 3." height="2cm"><p class="caption">
Posterior distribution of selected latent rankings for model 3.
</p>
</div>
<p>Finally, we add a batch with the last data and re-update the
model.</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch4</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">1601</span><span class="op">:</span><span class="fl">5000</span>, <span class="op">]</span></span>
<span><span class="va">model4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  <span class="va">model3</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span>rankings <span class="op">=</span> <span class="va">data_batch4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The posterior uncertainty is now very small:</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model4</span>, parameter <span class="op">=</span> <span class="st">"rho"</span>, items <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"shrimp"</span>, <span class="st">"sea eel"</span>, <span class="st">"tuna"</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_model4_rho-1.png" alt="Posterior distribution of selected latent rankings for model 4." height="2cm"><p class="caption">
Posterior distribution of selected latent rankings for model 4.
</p>
</div>
<p>Below is a comparison of the posterior intervals of the dispersion
parameter for each model. Note how the intervals get increasingly
narrower as more data is added.</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span>, </span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   parameter  mean median          hpdi central_interval</span></span>
<span><span class="co">#&gt; 1     alpha 1.768  1.766 [1.603,1.917]    [1.604,1.922]</span></span>
<span><span class="co">#&gt; 2     alpha 1.777  1.773 [1.630,1.935]    [1.620,1.931]</span></span>
<span><span class="co">#&gt; 3     alpha 1.753  1.756 [1.676,1.827]    [1.677,1.827]</span></span>
<span><span class="co">#&gt; 4     alpha 1.712  1.714 [1.667,1.748]    [1.669,1.752]</span></span></code></pre></div>
<p>As an assurance that the implementation is correct, we can compare
the final model to what we get by running <code>compute_mallows</code>
on the complete dataset:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_bmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_mallows.html">compute_mallows</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span>rankings <span class="op">=</span> <span class="va">sushi_rankings</span><span class="op">)</span>,</span>
<span>  compute_options <span class="op">=</span> <span class="fu"><a href="../reference/set_compute_options.html">set_compute_options</a></span><span class="op">(</span>nmc <span class="op">=</span> <span class="fl">5000</span>, burnin <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can compare the posteriors for <span class="math inline">\(\alpha\)</span> of the two models. Note that
although both are rather wiggly, they agree very well about location and
scale.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_mod_bmm-1.png" alt="Posterior distribution of scale parameter for Metropolis-Hastings run on the complete data." height="3cm"><p class="caption">
Posterior distribution of scale parameter for Metropolis-Hastings run on
the complete data.
</p>
</div>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_complete_model4_alpha-1.png" alt="Posterior distribution of scale parameter for model 4." height="3cm"><p class="caption">
Posterior distribution of scale parameter for model 4.
</p>
</div>
<p>The posterior intervals are also in good agreement.</p>
<div class="sourceCode" id="cb20"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span></span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span>,</span>
<span>  <span class="fu"><a href="../reference/compute_posterior_intervals.html">compute_posterior_intervals</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span><span class="co">#&gt;   parameter  mean median          hpdi central_interval</span></span>
<span><span class="co">#&gt; 1     alpha 1.691  1.690 [1.648,1.734]    [1.643,1.732]</span></span>
<span><span class="co">#&gt; 2     alpha 1.712  1.714 [1.667,1.748]    [1.669,1.752]</span></span></code></pre></div>
<p>The cumulative probability consensus is also in good agrement:</p>
<div class="sourceCode" id="cb21"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/compute_consensus.html">compute_consensus</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span></span>
<span><span class="co">#&gt;      cluster ranking          item cumprob</span></span>
<span><span class="co">#&gt; 1  Cluster 1       1    fatty tuna   1.000</span></span>
<span><span class="co">#&gt; 2  Cluster 1       2    salmon roe   1.000</span></span>
<span><span class="co">#&gt; 3  Cluster 1       3          tuna   1.000</span></span>
<span><span class="co">#&gt; 4  Cluster 1       4        shrimp   1.000</span></span>
<span><span class="co">#&gt; 5  Cluster 1       5       sea eel   1.000</span></span>
<span><span class="co">#&gt; 6  Cluster 1       6     tuna roll   0.835</span></span>
<span><span class="co">#&gt; 7  Cluster 1       7         squid   1.000</span></span>
<span><span class="co">#&gt; 8  Cluster 1       8    sea urchin   1.000</span></span>
<span><span class="co">#&gt; 9  Cluster 1       9           egg   1.000</span></span>
<span><span class="co">#&gt; 10 Cluster 1      10 cucumber roll   1.000</span></span>
<span><span class="fu"><a href="../reference/compute_consensus.html">compute_consensus</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span></span>
<span><span class="co">#&gt;      cluster ranking          item cumprob</span></span>
<span><span class="co">#&gt; 1  Cluster 1       1    fatty tuna       1</span></span>
<span><span class="co">#&gt; 2  Cluster 1       2    sea urchin       1</span></span>
<span><span class="co">#&gt; 3  Cluster 1       3          tuna       1</span></span>
<span><span class="co">#&gt; 4  Cluster 1       4    salmon roe       1</span></span>
<span><span class="co">#&gt; 5  Cluster 1       5        shrimp       1</span></span>
<span><span class="co">#&gt; 6  Cluster 1       6       sea eel       1</span></span>
<span><span class="co">#&gt; 7  Cluster 1       7     tuna roll       1</span></span>
<span><span class="co">#&gt; 8  Cluster 1       8         squid       1</span></span>
<span><span class="co">#&gt; 9  Cluster 1       9           egg       1</span></span>
<span><span class="co">#&gt; 10 Cluster 1      10 cucumber roll       1</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="new-users-with-partial-or-complete-rankings">New users with partial or complete rankings<a class="anchor" aria-label="anchor" href="#new-users-with-partial-or-complete-rankings"></a>
</h2>
<p>The functionality extends directly to partial ranks, including both
top-<span class="math inline">\(k\)</span> rankings and rankings missing
at random. Pairwise preferences are also supported, although not
demonstrated here.</p>
<p>For this demonstration we shall assume that we can only observe the
top-5 ranked items from each user in the <code>sushi_rankings</code>
dataset.</p>
<div class="sourceCode" id="cb22"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_partial</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span></span>
<span><span class="va">data_partial</span><span class="op">[</span><span class="va">data_partial</span> <span class="op">&gt;</span> <span class="fl">5</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_partial</span><span class="op">)</span></span>
<span><span class="co">#&gt;      shrimp sea eel tuna squid sea urchin salmon roe egg fatty tuna tuna roll cucumber roll</span></span>
<span><span class="co">#&gt; [1,]      2      NA   NA     3          4          1   5         NA        NA            NA</span></span>
<span><span class="co">#&gt; [2,]      1      NA   NA     4         NA         NA   3          5        NA             2</span></span>
<span><span class="co">#&gt; [3,]      2      NA    3     4         NA         NA  NA          1         5            NA</span></span>
<span><span class="co">#&gt; [4,]      4      NA    5    NA          1          2  NA          3        NA            NA</span></span>
<span><span class="co">#&gt; [5,]      4      NA   NA     5         NA          3   2         NA         1            NA</span></span>
<span><span class="co">#&gt; [6,]      4      NA    2    NA         NA          5   1         NA        NA             3</span></span></code></pre></div>
<p>Again, assume we start out with a batch of data, this time with 100
rankings:</p>
<div class="sourceCode" id="cb23"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch1</span> <span class="op">&lt;-</span> <span class="va">data_partial</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span></span></code></pre></div>
<p>We estimate this model using <code><a href="../reference/compute_mallows.html">compute_mallows()</a></code>. Since
there are <code>NA</code>s in the data, <code><a href="../reference/compute_mallows.html">compute_mallows()</a></code>
will run imputation over the missing ranks.</p>
<div class="sourceCode" id="cb24"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model1</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_mallows.html">compute_mallows</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span>,</span>
<span>  compute_options <span class="op">=</span> <span class="fu"><a href="../reference/set_compute_options.html">set_compute_options</a></span><span class="op">(</span>nmc <span class="op">=</span> <span class="fl">10000</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>The trace plot shows that convergence is reached quickly.</p>
<div class="sourceCode" id="cb25"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/assess_convergence.html">assess_convergence</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="convergence_smc_partial-1.png" alt="Trace plot for SMC model." height="4cm"><p class="caption">
Trace plot for SMC model.
</p>
</div>
<p>We set the burnin to 300.</p>
<div class="sourceCode" id="cb26"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/burnin.html">burnin</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">300</span></span></code></pre></div>
<p>Below is the posterior for <span class="math inline">\(\alpha\)</span> after this initial run:</p>
<div class="sourceCode" id="cb27"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model1</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_init_posterior_partial-1.png" alt="Posterior distribution of scale parameter after initial run." height="3cm"><p class="caption">
Posterior distribution of scale parameter after initial run.
</p>
</div>
<p>Next, assume we receive 100 more top-5 rankings:</p>
<div class="sourceCode" id="cb28"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch2</span> <span class="op">&lt;-</span> <span class="va">data_partial</span><span class="op">[</span><span class="fl">101</span><span class="op">:</span><span class="fl">200</span>, <span class="op">]</span></span></code></pre></div>
<p>We now update the initial model, using SMC. By default, a uniform
distribution is used to propose new values of augmented ranks. The
pseudo-likelihood proposal developed in <span class="citation">Stein (<a href="#ref-steinSequentialInferenceMallows2023">2023</a>)</span> can be
used instead, by setting <code>aug_method = "pseudo"</code> in the call
to <code><a href="../reference/set_compute_options.html">set_compute_options()</a></code>, and we do this here.</p>
<div class="sourceCode" id="cb29"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model1</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch2</span><span class="op">)</span>, </span>
<span>  smc_options <span class="op">=</span> <span class="fu"><a href="../reference/set_smc_options.html">set_smc_options</a></span><span class="op">(</span>n_particles <span class="op">=</span> <span class="fl">1000</span><span class="op">)</span>,</span>
<span>  compute_options <span class="op">=</span> <span class="fu"><a href="../reference/set_compute_options.html">set_compute_options</a></span><span class="op">(</span></span>
<span>    aug_method <span class="op">=</span> <span class="st">"pseudo"</span>, pseudo_aug_metric <span class="op">=</span> <span class="st">"footrule"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>Below is the posterior for <span class="math inline">\(\alpha\)</span>:</p>
<div class="sourceCode" id="cb30"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_updated_posterior_partial-1.png" alt="Posterior distribution of scale parameter after updating the model based on new rankings." height="3cm"><p class="caption">
Posterior distribution of scale parameter after updating the model based
on new rankings.
</p>
</div>
<p>When even more data arrives, we can update the model again. For
example, assume we now get a set of complete rankings, with no
missingness:</p>
<div class="sourceCode" id="cb31"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch3</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">201</span><span class="op">:</span><span class="fl">300</span>, <span class="op">]</span></span></code></pre></div>
<p>We update the model just as before:</p>
<div class="sourceCode" id="cb32"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span><span class="va">model2</span>, new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb33"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="smc_second_updated_posterior_partial-1.png" alt="Posterior distribution of scale parameter after updating the model based on new rankings." height="3cm"><p class="caption">
Posterior distribution of scale parameter after updating the model based
on new rankings.
</p>
</div>
</div>
<div class="section level2">
<h2 id="users-updating-their-rankings">Users updating their rankings<a class="anchor" aria-label="anchor" href="#users-updating-their-rankings"></a>
</h2>
<p>Another setting supported is when existing users update their partial
rankings. For example, users can initially give top-5 rankings, and
subsequently update these to top-10 rankings, top-20 rankings, etc.
Another setting is when there are ranks missing at random, and the users
subsequently provide these rankings.</p>
<p>The main methodological issue in this case, is that the augmented
rankings at the previous SMC timepoint may be in conflict with the new
rankings. In this case, the augmented rankings must be corrected, as
described in Chapter 6 of <span class="citation">Stein (<a href="#ref-steinSequentialInferenceMallows2023">2023</a>)</span>. We
provide an example again with the sushi data.</p>
<p>We assume that the initial batch of data contains top-3 rankings
provided by the first 100 users.</p>
<div class="sourceCode" id="cb34"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">123</span><span class="op">)</span></span>
<span><span class="va">sushi_reduced</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">1</span><span class="op">:</span><span class="fl">100</span>, <span class="op">]</span></span>
<span><span class="va">data_batch1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sushi_reduced</span> <span class="op">&gt;</span> <span class="fl">3</span>, <span class="cn">NA_real_</span>, <span class="va">sushi_reduced</span><span class="op">)</span></span></code></pre></div>
<p>To keep track of existing users updating their preferences, we also
need a user ID in this case, which is required to be a number
vector.</p>
<div class="sourceCode" id="cb35"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span></span>
<span><span class="co">#&gt;   shrimp sea eel tuna squid sea urchin salmon roe egg fatty tuna tuna roll cucumber roll</span></span>
<span><span class="co">#&gt; 1      2      NA   NA     3         NA          1  NA         NA        NA            NA</span></span>
<span><span class="co">#&gt; 2      1      NA   NA    NA         NA         NA   3         NA        NA             2</span></span>
<span><span class="co">#&gt; 3      2      NA    3    NA         NA         NA  NA          1        NA            NA</span></span>
<span><span class="co">#&gt; 4     NA      NA   NA    NA          1          2  NA          3        NA            NA</span></span>
<span><span class="co">#&gt; 5     NA      NA   NA    NA         NA          3   2         NA         1            NA</span></span>
<span><span class="co">#&gt; 6     NA      NA    2    NA         NA         NA   1         NA        NA             3</span></span></code></pre></div>
<p>We fit the standard Metropolis-Hastings algorithm to these data,
yielding a starting point.</p>
<div class="sourceCode" id="cb36"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">mod_init</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_mallows.html">compute_mallows</a></span><span class="op">(</span></span>
<span>  data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span></span>
<span>    rankings <span class="op">=</span> <span class="va">data_batch1</span>,</span>
<span>    user_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="op">)</span></span></code></pre></div>
<p>Convergence seems to be quick, and we set the burnin to 300.</p>
<div class="sourceCode" id="cb37"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/assess_convergence.html">assess_convergence</a></span><span class="op">(</span><span class="va">mod_init</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_batch1_burnin-1.png" alt="Trace plot for initial run on sushi batch 1." height="4cm"><p class="caption">
Trace plot for initial run on sushi batch 1.
</p>
</div>
<div class="sourceCode" id="cb38"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/burnin.html">burnin</a></span><span class="op">(</span><span class="va">mod_init</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">300</span></span></code></pre></div>
<p>Next, assume we receive top-5 rankings from the same users. We now
update the model using SMC.</p>
<div class="sourceCode" id="cb39"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sushi_reduced</span> <span class="op">&gt;</span> <span class="fl">5</span>, <span class="cn">NA_real_</span>, <span class="va">sushi_reduced</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch2</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_batch2</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">model2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">mod_init</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span></span>
<span>    rankings <span class="op">=</span> <span class="va">data_batch2</span>, user_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch2</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>  compute_options <span class="op">=</span> <span class="fu"><a href="../reference/set_compute_options.html">set_compute_options</a></span><span class="op">(</span></span>
<span>    aug_method <span class="op">=</span> <span class="st">"pseudo"</span>, pseudo_aug_metric <span class="op">=</span> <span class="st">"footrule"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span></code></pre></div>
<p>We can plot the posterior distributions of <span class="math inline">\(\alpha\)</span> before and after.</p>
<div class="sourceCode" id="cb40"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_init</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Posterior of dispersion parameter after data batch 1"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_batch1_posterior-1.png" alt="Posterior after sushi batch 1." height="4cm"><p class="caption">
Posterior after sushi batch 1.
</p>
</div>
<div class="sourceCode" id="cb41"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model2</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Posterior of dispersion parameter after data batch 2"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_batch2_posterior-1.png" alt="Posterior after sushi batch 2." height="4cm"><p class="caption">
Posterior after sushi batch 2.
</p>
</div>
<p>Next, assume we receive top-8 rankings from the same users.</p>
<div class="sourceCode" id="cb42"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch3</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html" class="external-link">ifelse</a></span><span class="op">(</span><span class="va">sushi_reduced</span> <span class="op">&gt;</span> <span class="fl">8</span>, <span class="cn">NA_real_</span>, <span class="va">sushi_reduced</span><span class="op">)</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html" class="external-link">seq_len</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Before proceeding, it is instructive to study why this situation
needs special care. Below are the augmented rankings for user 1 in
particle 1:</p>
<div class="sourceCode" id="cb43"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">v1</span> <span class="op">&lt;-</span> <span class="va">model2</span><span class="op">$</span><span class="va">augmented_rankings</span><span class="op">[</span>, <span class="fl">1</span>, <span class="fl">1</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  2  7 10  3  4  1  5  6  8  9</span></span></code></pre></div>
<p>Next, we show the data provided by user 1 in
<code>data_batch3</code>:</p>
<div class="sourceCode" id="cb44"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">v2a</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/unname.html" class="external-link">unname</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">[</span><span class="fl">1</span>, <span class="op">]</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="co">#&gt;  [1]  2  8 NA  3  4  1  5 NA  7  6</span></span></code></pre></div>
<p>By comparing the non-missing ranks, we can check if they are
consistent or not:</p>
<div class="sourceCode" id="cb45"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="op">(</span><span class="va">v2b</span> <span class="op">&lt;-</span> <span class="va">v2a</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">v2a</span><span class="op">)</span><span class="op">]</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 2 8 3 4 1 5 7 6</span></span>
<span><span class="va">v1</span><span class="op">[</span><span class="va">v1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">v2b</span><span class="op">]</span></span>
<span><span class="co">#&gt; [1] 2 7 3 4 1 5 6 8</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/all.html" class="external-link">all</a></span><span class="op">(</span><span class="va">v1</span><span class="op">[</span><span class="va">v1</span> <span class="op"><a href="https://rdrr.io/r/base/match.html" class="external-link">%in%</a></span> <span class="va">v2b</span><span class="op">]</span> <span class="op">==</span> <span class="va">v2b</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] FALSE</span></span></code></pre></div>
<p>The provided data are not consistent with the augmented rankings in
this case. This means that the augmented rankings for user 1 in particle
1 need to be corrected by the algorithm.</p>
<p>Luckily, this happens automatically in our implementation, so we can
update the model again.</p>
<div class="sourceCode" id="cb46"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model3</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">mod_init</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span></span>
<span>    rankings <span class="op">=</span> <span class="va">data_batch3</span>, user_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch3</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Next we plot the posterior:</p>
<div class="sourceCode" id="cb47"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model3</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Posterior of dispersion parameter after data batch 3"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_batch3_posterior-1.png" alt="Posterior after sushi batch 3." height="4cm"><p class="caption">
Posterior after sushi batch 3.
</p>
</div>
<p>Now assume we get a batch of new users, without missing ranks. These
can be treated just as the other ones, but we need new user IDs.</p>
<div class="sourceCode" id="cb48"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data_batch4</span> <span class="op">&lt;-</span> <span class="va">sushi_rankings</span><span class="op">[</span><span class="fl">500</span><span class="op">:</span><span class="fl">600</span>, <span class="op">]</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch4</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">500</span><span class="op">:</span><span class="fl">600</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/utils/head.html" class="external-link">head</a></span><span class="op">(</span><span class="va">data_batch4</span><span class="op">)</span></span>
<span><span class="co">#&gt;     shrimp sea eel tuna squid sea urchin salmon roe egg fatty tuna tuna roll cucumber roll</span></span>
<span><span class="co">#&gt; 500      6       5    4     8          2          3   7          1         9            10</span></span>
<span><span class="co">#&gt; 501      3       9    5     8          4          2   6          1         7            10</span></span>
<span><span class="co">#&gt; 502      3       1    8     5          4          7   9          2         6            10</span></span>
<span><span class="co">#&gt; 503      8       6    3     1          4          5   9          7         2            10</span></span>
<span><span class="co">#&gt; 504      4       7    1     2          9         10   3          8         5             6</span></span>
<span><span class="co">#&gt; 505      1       5    6     8          3          4   9          2         7            10</span></span></code></pre></div>
<div class="sourceCode" id="cb49"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model4</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/update_mallows.html">update_mallows</a></span><span class="op">(</span></span>
<span>  model <span class="op">=</span> <span class="va">model3</span>, </span>
<span>  new_data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span></span>
<span>    rankings <span class="op">=</span> <span class="va">data_batch4</span>, user_ids <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/colnames.html" class="external-link">rownames</a></span><span class="op">(</span><span class="va">data_batch4</span><span class="op">)</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Here is the posterior for this model.</p>
<div class="sourceCode" id="cb50"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">model4</span><span class="op">)</span> <span class="op">+</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html" class="external-link">ggtitle</a></span><span class="op">(</span><span class="st">"Posterior of dispersion parameter after data batch 4"</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_batch4_posterior-1.png" alt="Posterior after sushi batch 4." height="4cm"><p class="caption">
Posterior after sushi batch 4.
</p>
</div>
<p>We can confirm that the implementation is sensible by giving the
complete data to <code>compute_mallows</code>:</p>
<div class="sourceCode" id="cb51"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">full_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html" class="external-link">rbind</a></span><span class="op">(</span><span class="va">data_batch3</span>, <span class="va">data_batch4</span><span class="op">)</span></span>
<span><span class="va">mod_bmm</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/compute_mallows.html">compute_mallows</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="../reference/setup_rank_data.html">setup_rank_data</a></span><span class="op">(</span>rankings <span class="op">=</span> <span class="va">full_data</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>The trace plot indicates good convergence, and we set the burnin to
300.</p>
<div class="sourceCode" id="cb52"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/assess_convergence.html">assess_convergence</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_burnin-1.png" alt="Trace plot for MCMC run on sushi data." height="4cm"><p class="caption">
Trace plot for MCMC run on sushi data.
</p>
</div>
<div class="sourceCode" id="cb53"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="../reference/burnin.html">burnin</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span> <span class="op">&lt;-</span> <span class="fl">300</span></span></code></pre></div>
<p>We see that the posterior is close to the one of
<code>model4</code>:</p>
<div class="sourceCode" id="cb54"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/graphics/plot.default.html" class="external-link">plot</a></span><span class="op">(</span><span class="va">mod_bmm</span><span class="op">)</span></span></code></pre></div>
<div class="figure">
<img src="sushi_updated_bmm_posterior-1.png" alt="Posterior for MCMC on sushi data." height="4cm"><p class="caption">
Posterior for MCMC on sushi data.
</p>
</div>
</div>
<div class="section level2 unnumbered">
<h2 class="unnumbered" id="references">References<a class="anchor" aria-label="anchor" href="#references"></a>
</h2>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-kamishima2003nantonac" class="csl-entry">
Kamishima, Toshihiro. 2003. <span>“Nantonac Collaborative Filtering:
Recommendation Based on Order Responses.”</span> In <em>Proceedings of
the Ninth ACM SIGKDD International Conference on Knowledge Discovery and
Data Mining</em>, 583–88.
</div>
<div id="ref-steinSequentialInferenceMallows2023" class="csl-entry">
Stein, Anja. 2023. <span>“Sequential <span>Inference</span> with the
<span>Mallows Model</span>.”</span> PhD thesis, Lancaster University.
</div>
</div>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p></p>
<p>Developed by Oystein Sorensen, Waldir Leoncio, Valeria Vitelli, Marta Crispino, Qinghua Liu, Cristina Mollica, Luca Tardella, Anja Stein.</p>
</div>

<div class="pkgdown-footer-right">
  <p></p>
<p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.7.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
